#!/usr/bin/env sh
. "$(dirname "$0")/_/husky.sh"

echo "Running pre-commit checks..."

# Run staged linters & formatters (fast, staged-only)
npx --no-install lint-staged || exit $?

# Run quick secret pattern checks on staged files
sh ./scripts/pre-commit-secrets.sh || exit $?

# Type-check (can be skipped by setting SKIP_TYPECHECK=1)
if [ -z "$SKIP_TYPECHECK" ]; then
  echo "Running TypeScript typecheck..."
  npx --no-install tsc -p tsconfig.json --noEmit || { echo "Typecheck failed"; exit 1; }
fi

# Optional: run fast tests only when explicitly enabled (RUN_UNIT_TESTS=1)
if [ "$RUN_UNIT_TESTS" = "1" ]; then
  echo "Running unit tests (fast)..."
  npx --no-install vitest run --run --threads 1 || { echo "Unit tests failed"; exit 1; }
fi

echo "Pre-commit checks passed âœ…"
