name: Bundle Size Check

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

# Reliability: Cancel outdated runs to save resources
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  bundle-size:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
        timeout-minutes: 5

      - name: Install dependencies
        run: npm ci
        timeout-minutes: 5

      - name: Build production bundle
        run: npm run build
        timeout-minutes: 5
        env:
          NODE_ENV: production

      - name: Analyze bundle
        id: analyze
        timeout-minutes: 2
        run: |
          echo "üì¶ Analyzing Bundle Sizes..."
          echo ""

          # Get bundle sizes (gzip compressed, as that's what browsers download)
          MAIN_SIZE_BYTES=$(find dist/assets -name 'index-*.js' -exec cat {} \; | gzip -c | wc -c)
          WEBLLM_SIZE_BYTES=$(find dist/assets -name 'vendor-webllm-*.js' -exec cat {} \; | gzip -c | wc -c 2>/dev/null || echo 0)
          TFJS_SIZE_BYTES=$(find dist/assets -name 'vendor-tfjs-*.js' -exec cat {} \; | gzip -c | wc -c 2>/dev/null || echo 0)

          # Convert to human-readable
          MAIN_SIZE=$(echo "$MAIN_SIZE_BYTES" | numfmt --to=iec-i --suffix=B 2>/dev/null || echo "${MAIN_SIZE_BYTES}B")
          WEBLLM_SIZE=$(echo "$WEBLLM_SIZE_BYTES" | numfmt --to=iec-i --suffix=B 2>/dev/null || echo "${WEBLLM_SIZE_BYTES}B")
          TFJS_SIZE=$(echo "$TFJS_SIZE_BYTES" | numfmt --to=iec-i --suffix=B 2>/dev/null || echo "${TFJS_SIZE_BYTES}B")

          echo "üìä Bundle Sizes (gzip compressed):"
          echo "  Main: $MAIN_SIZE ($MAIN_SIZE_BYTES bytes)"
          echo "  WebLLM: $WEBLLM_SIZE ($WEBLLM_SIZE_BYTES bytes)"
          echo "  TensorFlow.js: $TFJS_SIZE ($TFJS_SIZE_BYTES bytes)"
          echo ""

          # Calculate vendor bundle size (all vendor chunks except WebLLM and TFJS)
          VENDOR_SIZE_BYTES=$(find dist/assets -name 'vendor-*.js' ! -name '*webllm*' ! -name '*tfjs*' -exec cat {} \; | gzip -c | wc -c 2>/dev/null || echo 0)

          # Convert to human-readable
          VENDOR_SIZE=$(echo "$VENDOR_SIZE_BYTES" | numfmt --to=iec-i --suffix=B 2>/dev/null || echo "${VENDOR_SIZE_BYTES}B")

          # Set outputs
          echo "main_size=$MAIN_SIZE" >> $GITHUB_OUTPUT
          echo "main_size_bytes=$MAIN_SIZE_BYTES" >> $GITHUB_OUTPUT
          echo "webllm_size=$WEBLLM_SIZE" >> $GITHUB_OUTPUT
          echo "tfjs_size=$TFJS_SIZE" >> $GITHUB_OUTPUT
          echo "vendor_size=$VENDOR_SIZE" >> $GITHUB_OUTPUT
          echo "vendor_size_bytes=$VENDOR_SIZE_BYTES" >> $GITHUB_OUTPUT

          # Check budgets (from package.json size-limit configuration)
          # Main bundle budget: 500 kB (512000 bytes)
          # WebLLM budget: 7 MB (7340032 bytes)
          # TFJS budget: 3 MB (3145728 bytes)

          ALL_PASS=true

          if [ "$MAIN_SIZE_BYTES" -gt 512000 ]; then
            echo "‚ùå Main bundle exceeds 500 kB budget"
            ALL_PASS=false
          else
            echo "‚úÖ Main bundle within budget (500 kB)"
          fi

          if [ "$WEBLLM_SIZE_BYTES" -gt 7340032 ]; then
            echo "‚ùå WebLLM bundle exceeds 7 MB budget"
            ALL_PASS=false
          else
            echo "‚úÖ WebLLM bundle within budget (7 MB)"
          fi

          if [ "$TFJS_SIZE_BYTES" -gt 3145728 ]; then
            echo "‚ùå TensorFlow.js bundle exceeds 3 MB budget"
            ALL_PASS=false
          else
            echo "‚úÖ TensorFlow.js bundle within budget (3 MB)"
          fi

          # Vendor bundle budget: 1 MB (1048576 bytes)
          if [ "$VENDOR_SIZE_BYTES" -gt 1048576 ]; then
            echo "‚ùå Vendor bundle exceeds 1 MB budget"
            ALL_PASS=false
          else
            echo "‚úÖ Vendor bundle within budget (1 MB)"
          fi

          if [ "$ALL_PASS" = true ]; then
            echo "within_budget=true" >> $GITHUB_OUTPUT
            echo ""
            echo "‚úÖ All bundles within budget!"
          else
            echo "within_budget=false" >> $GITHUB_OUTPUT
            echo ""
            echo "‚ö†Ô∏è  Some bundles exceed budget - review required"
            # Don't fail the build, just warn
          fi

      - name: Generate bundle report
        if: github.event_name == 'pull_request'
        id: report
        run: |
          # Generate bundle size report
          REPORT="## üì¶ Bundle Size Report

          ### Summary
          - Main bundle: ${{ steps.analyze.outputs.main_size }} (${{ steps.analyze.outputs.main_size_bytes }} bytes)
          - Vendor bundle: ${{ steps.analyze.outputs.vendor_size }} (${{ steps.analyze.outputs.vendor_size_bytes }} bytes)
          - Status: ${{ steps.analyze.outputs.within_budget == 'true' && '‚úÖ Within budget' || '‚ùå Exceeds budget' }}

          ### Detailed Breakdown
          "

          # Add detailed file list
          for f in dist/assets/*.js; do
            if [ -f "$f" ]; then
              SIZE=$(stat -c%s "$f")
              SIZE_KB=$(echo "scale=2; $SIZE / 1024" | bc 2>/dev/null || echo "$((SIZE / 1024))")
              REPORT="${REPORT}
          - $(basename "$f"): ${SIZE_KB} kB"
            fi
          done

          # Save report for PR comment
          echo "report<<EOF" >> $GITHUB_OUTPUT
          echo "$REPORT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check budget status
        if: steps.analyze.outputs.within_budget != 'true'
        run: |
          echo "‚ùå Bundle size budget exceeded!"
          echo "Review the bundle analysis above for details."
          exit 1

      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          retries: 3
          script: |
            const fs = require('fs');
            const path = require('path');

            // Build the comment body
            let commentBody = '## üì¶ Bundle Size Report\n\n';

            try {
              const files = fs.readdirSync('dist/assets').filter(f => f.endsWith('.js'));
              const sizes = files.map(f => {
                const stats = fs.statSync(path.join('dist/assets', f));
                return `- ${f}: ${(stats.size / 1024).toFixed(2)} kB`;
              });
              commentBody += sizes.join('\n');
            } catch (error) {
              console.log('Warning: Could not read bundle files:', error.message);
              commentBody += '‚ö†Ô∏è Could not read bundle file details\n';
            }

            // Add summary info
            const mainSize = '${{ steps.analyze.outputs.main_size }}' || 'N/A';
            const vendorSize = '${{ steps.analyze.outputs.vendor_size }}' || 'N/A';
            const withinBudget = '${{ steps.analyze.outputs.within_budget }}' === 'true';

            commentBody += `\n\n### Summary\n`;
            commentBody += `- Main bundle: ${mainSize}\n`;
            commentBody += `- Vendor bundle: ${vendorSize}\n`;
            commentBody += `- Status: ${withinBudget ? '‚úÖ Within budget' : '‚ùå Exceeds budget'}\n`;

            // Try to post the comment with retries
            let lastError;
            for (let attempt = 1; attempt <= 3; attempt++) {
              try {
                console.log(`Attempting to post PR comment (attempt ${attempt})...`);
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: commentBody
                });
                console.log('‚úÖ PR comment posted successfully');
                return;
              } catch (error) {
                lastError = error;
                console.log(`‚ö†Ô∏è Attempt ${attempt} failed: ${error.message}`);
                if (attempt < 3) {
                  const delay = attempt * 2000; // 2s, 4s, 6s
                  console.log(`Waiting ${delay}ms before retry...`);
                  await new Promise(resolve => setTimeout(resolve, delay));
                }
              }
            }

            console.log('‚ùå Failed to post PR comment after 3 attempts');
            console.log('Last error:', lastError.message);
            // Don't fail the workflow if commenting fails
            console.log('Continuing without PR comment...');
